<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AMO map</title>
<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script> -->
<link href='./css/mapstyle.css' rel='stylesheet' />
</head>

<body>
<div id="mapHead">Municipal results map</div>

<div id="mapWrap">
  <div id="mapLegend">
    <span style="background-color: #cccccc"></span><label>Results pending</label>
    <span style="background-color: #3EA144"></span><label>Election called</label>
    <span style="background-color: #7E5BBF"></span><label>Acclaimed</label>
    <span style="background-color: #c8b9e3"></span><label>Partial Acclaim</label>
  </div>
  <div id="mapBtnHolder">
    <div id="resetMap" class="mapBtn">All municipalities</div>
    <div id="southMap" class="mapBtn">Southern Ontario</div>
  </div>
  <div id="map"></div>
</div>

<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
<script>

var mapDiv = document.getElementById('map');

var resultsData = [];

// var amoUrl = 'http://k9test.amo.on.ca/rest/customtableitem.customtable.Municipality_ElectionData?format=json&hash=bc935c67d309df9a18350c964b23cdc710db366230e874629b4fa601903d8f68';
// console.log(amoUrl);
// var jsonResult = [];

var popup = L.popup({autoPan: false});
var closeTooltip;

var resetMapBtn = document.getElementById('resetMap');
var resetSouthBtn = document.getElementById('southMap');

var southWest = L.latLng(40.38, -96.65),
    northEast = L.latLng(57.11, -72.0),
    bounds = L.latLngBounds(southWest, northEast);


var southWestBounds = L.latLng(42.89, -82.95),
    northEastBounds = L.latLng(44.91, -74.99),
    initBounds = L.latLngBounds(southWestBounds, northEastBounds);

var mapOptions = {
	  minZoom: 5,
    maxZoom: 10,
    zoomControl: false,
    maxBounds:bounds
};

function mapLoad() {

      L.mapbox.accessToken = 'pk.eyJ1Ijoid2lsbGlhbWJlbmRhdmlzIiwiYSI6IlVrb3BGVzQifQ.jeHxDCnpXXvAXKfAFEYG-A';
      var map = L.mapbox.map('map', null, mapOptions);

      map.fitBounds(initBounds);

      var zoomControl = new L.Control.Zoom({ position: 'topright' }).addTo(map);

      map.scrollWheelZoom.disable();

      var baseLayer = L.mapbox.tileLayer('mapbox.light').addTo(map);

      var munLayer = L.geoJson(null, {
          style: style,
          onEachFeature: onEachFeature
          });


      var prOutline = L.geoJson(null, {
          style: styleBounds,
          // onEachFeature: disableFeature
          });

      var munLayerLoad = omnivore.topojson('./json/mun-land-clean.json', null, munLayer)
        .on('ready', function() {
            // http://leafletjs.com/reference.html#map-fitbounds
            // map.fitBounds(munLayerLoad.getBounds());
      //       console.log('munLayerLoad', munLayerLoad._layers)
      //       munLayerLoad.eachLayer(function(layer) {
        //    // downloadData(i);
        //    console.log('each municipality');
        // });
        }).addTo(map);

      var prOutlineLoad = omnivore.topojson('./json/on-boundary.json', null, prOutline)
        .addTo(map);


      resetMapBtn.addEventListener("click", function(){
          if (this.className === 'active') {
              map.fitBounds(bounds);
          } else {
              map.fitBounds(bounds);
          }
          return false;
      });

      resetSouthBtn.addEventListener("click", function(){
          if (this.className === 'active') {
              map.fitBounds(initBounds);
          } else {
              map.fitBounds(initBounds);
          }
          return false;
      });


      function style(feature) {
      	return {
      	        fillColor: getFillColour(feature.properties),
      	        weight: 0.4,
      	        opacity: 0.6,
      	        color: '#fff',
      	        fillOpacity: 0.5,
                smoothFactor: 0
          };
      };

      function getFillColour(p) {
      
        for (i = 0; i < resultsData.length; i++) {
          
          if (p.ASSESSMENT === resultsData[i].ASSESSMENT) {
            if (resultsData[i].IsPublished == true) {
              return '#3EA144';
            } else if (resultsData[i].IsPublished == false) {
              return '#7E5BBF';
            } else {
              return '#cccccc';
            }
            break;
          }
        }
        return 'red';
      }

      function styleBounds(feature) {
      	return {
      	        fillColor: '#fff',
      	        weight: 0.6,
      	        opacity: 0.2,
      	        color: '#333',
      	        fillOpacity: 0
          };
      };

      function onEachFeature(feature, layer) {
          layer.on({
              mouseover: displayPopup,
              mouseout: resetHighlight,
              click: clickPopup
          });
      }

      function displayPopup(e) {
          var layer = e.target;
          var p = layer.feature.properties;

          for (i = 0; i < resultsData.length; i++) {
            if (p.ASSESSMENT === resultsData[i].ASSESSMENT) {
              if (resultsData[i].IsPublished == true) {
                  popup.setContent(
                          '<span id="popupBanner" style="background-color:' + getFillColour(p) + '">' + p.LEGAL_NAME + '</span>' +
                    '<p><b>Population:</b> ' + parseInt(resultsData[i].Population) + '</p>' +
                    '<p><b>Votes:</b> ' + resultsData[i].NumberofVoters + '</p>' +
                          '<p>*Click to see the full results below</p>', {maxWidth: "auto"}
                    );
                    } else {
                          popup.setContent(
                          '<span id="popupBanner" style="background-color:#cccccc">' + p.LEGAL_NAME + '</span>' +
                          '<p><b>Elected: </b>Results pending</p>' +
                          '<p><b>Votes: </b>counting</p>' +
                          '<p>*Click to see the full results below</p>', {maxWidth: "auto"}
                          );
                      }
                      break;
              } else {
                  // break;
            }
          }

          popup.setLatLng(layer.getBounds().getCenter());
          map.openPopup(popup);

            if (!popup._map) popup.openOn(map);
            window.clearTimeout(closeTooltip);

            layer.setStyle({
                weight: 1,
                color: '#555',
                opacity: 1,
                fillOpacity: 0.3
                    });

          if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
          }
        };

       function clickPopup(e) {
          var layer = e.target;
            var p = layer.feature.properties;
                  map.fitBounds(layer.getBounds());
                  map.openPopup(popup);
              };

      function resetHighlight(e) {
          munLayer.resetStyle(e.target);
          closeTooltip = window.setTimeout(function() {
                map.closePopup();
            }, 100);
      }; 
};

// function disableFeature() {
// 	mouseover: {
// 		// mapDiv.style.pointerEvents = 'none';
// 	}
// }

$(document).ready(function(){
  console.log('ready');

  // function omniInit(json, topo, bounds, water, cities) {

    $.ajax({
        url: './data/results.json',
        dataType: "json",
        success: function(data){
          console.log('success');
            // console.log('data', data);
            // console.log('data1', data.customtableitem_customtable_Municipality_ElectionDatas);
            // console.log('data2', data.customtableitem_customtable_Municipality_ElectionDatas[0]);
            // console.log('data3', data.customtableitem_customtable_Municipality_ElectionDatas[0].customtable_Municipality_ElectionData);

          var dataOrg = data.customtableitem_customtable_Municipality_ElectionDatas[0].customtable_Municipality_ElectionData;

          console.log('dataOrg', dataOrg[1]);

          for (var x = 1; x < dataOrg.length; x++) {
              resultsData.push(dataOrg[x]);
          }
          console.log('jsonResult', resultsData);
          mapLoad();
        },
        error: function(data) {
          console.log('error');
        }
    });

    

   //    $.get(csv, function (response) {
   //      Papa.parse(response, {
   //          complete: function(results) {
   //          	  console.log('csvresults', results);
   //              for (var x = 1; x < results.data.length; x++) {
   //                resultsData.push(results.data[x]);
   //              }
  	//         }
  	//       });
   //      	  console.log('resultsData', resultsData);
  	// });

  	

      // var waterLabelLoad = omnivore.geojson(water, null, waterLabels)
      // .addTo(map);

      // var cityLabelLoad = omnivore.geojson(cities, null, cityLabels)
      // .addTo(map);
  // };

  // omniInit('./data/results.json', './json/mun-land-clean.json', './json/on-boundary.json', './json/water.geojson', './json/cities.geojson');

});
         
       
</script>
</body>
</html>
